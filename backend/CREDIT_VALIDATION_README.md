# מערכת וולידציית קרדיטים - Credit Validation System

## סקירה כללית

מערכת זו מוסיפה לוגיקה מתקדמת לוולידציית קרדיטים בהרשמה לשיעורים, בהתבסס על העמודות החדשות שהוספנו לטבלת `classes`:

- `class_type` - סוג הקרדיט שהשיעור מציע: `group`, `private`, או `both`
- `group_credits` - כמות הקרדיטים הקבוצתיים שהמשתמש מקבל
- `private_credits` - כמות הקרדיטים האישיים שהמשתמש מקבל

## מבנה המערכת

### 1. קובץ הוולידציה (`classCreditValidator.ts`)

הקובץ מכיל את כל הלוגיקה לוולידציית קרדיטים:

#### פונקציות עיקריות:

- `getClassCreditInfo(classId)` - מקבל מידע על קרדיטים של שיעור
- `validateCreditUsage()` - בודק אם השימוש בקרדיט תקין
- `getAllowedCreditTypes()` - מחזיר סוגי קרדיטים נתמכים
- `validateClassCategoryCompatibility()` - בודק תאימות בין סוג קרדיט לסוג שיעור
- `validateClassRegistration()` - פונקציה מקיפה לוולידציה מלאה

#### כללי הוולידציה:

1. **שיעורים מסוג `group`**:
   - יכולים להשתמש רק בקרדיטים קבוצתיים
   - חייבים להיות עם `category = 'subscription'`
   - חייבים שיהיה `group_credits > 0`

2. **שיעורים מסוג `private`**:
   - יכולים להשתמש רק בקרדיטים אישיים
   - חייבים להיות עם `category = 'private'`
   - חייבים שיהיה `private_credits > 0`

3. **שיעורים מסוג `both`**:
   - יכולים להשתמש בשני סוגי הקרדיטים
   - חייבים שיהיה לפחות אחד מהשדות `group_credits > 0` או `private_credits > 0`

### 2. עדכון ה-API (`registrations.ts`)

ה-API עודכן כדי להשתמש בוולידציה החדשה:

#### Endpoint חדש:
```
GET /api/registrations/class/:classId/credit-types
```
מחזיר מידע על סוגי הקרדיטים הזמינים לשיעור מסוים.

#### וולידציה אוטומטית:
כל הרשמה שמשתמשת בקרדיטים עוברת וולידציה אוטומטית לפני השמירה.

## דוגמאות שימוש

### 1. בדיקת קרדיטים זמינים לשיעור

```typescript
// Frontend
const response = await fetch(`/api/registrations/class/${classId}/credit-types`);
const creditInfo = await response.json();

console.log('Available credit types:', creditInfo.available_credit_types);
```

### 2. וולידציה אוטומטית בהרשמה

```typescript
// Backend - זה קורה אוטומטית
const creditValidation = await validateClassRegistration(
  classId,
  usedCredit,
  creditType,
  userId
);

if (!creditValidation.isValid) {
  throw new AppError(creditValidation.errorMessage, 400);
}
```

## הודעות שגיאה

המערכת מחזירה הודעות שגיאה בעברית:

- `"יש לבחור סוג קרדיט כאשר משתמשים בקרדיט"`
- `"סוג קרדיט 'group' אינו נתמך בשיעור זה. סוגי קרדיטים נתמכים: private"`
- `"אין מספיק קרדיטים זמינים מסוג 'group'"`
- `"סוג הקרדיט 'group' אינו תואם לסוג השיעור 'private'"`

## יתרונות המערכת

1. **וולידציה מרכזית** - כל הלוגיקה במקום אחד
2. **גמישות** - תמיכה בשילובים שונים של סוגי קרדיטים
3. **ביצועים** - שימוש באינדקסים לשיפור מהירות
4. **אבטחה** - בדיקות מקיפות לפני שמירה
5. **תחזוקה** - קל להוסיף כללים חדשים

## הרחבות עתידיות

המערכת תוכננה להיות מודולרית וניתן להרחיב אותה בקלות:

1. **סוגי קרדיטים נוספים** - הוספת סוגים כמו `zoom`, `workshop` וכו'
2. **כללי וולידציה מורכבים** - הוספת תנאים נוספים
3. **היסטוריית שינויים** - מעקב אחר שינויים בקרדיטים
4. **התראות** - הודעות למשתמשים על קרדיטים שעומדים לפוג

## בדיקות

כדי לבדוק שהמערכת עובדת:

1. נסה ליצור הרשמה עם קרדיט לא נתמך
2. נסה ליצור הרשמה עם קרדיט שלא תואם לסוג השיעור
3. בדוק את ה-endpoint החדש לקבלת סוגי קרדיטים
4. וודא שהודעות השגיאה מופיעות בעברית

## תמיכה

אם יש בעיות או שאלות:
1. בדוק את הלוגים בשרת
2. וודא שהעמודות החדשות קיימות בטבלה
3. בדוק שה-indexים נוצרו בהצלחה
4. וודא שה-imports תקינים
